# CompletableFuture å¼‚å¸¸å¤„ç†æµç¨‹å›¾

## ä¸‰å±‚å¼‚å¸¸å¤„ç†æœºåˆ¶

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                     ä¸»æµç¨‹å¼€å§‹                                 â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                      â”‚
          â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
          â”‚                        â”‚
          â–¼                        â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”    â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚  å¼‚æ­¥ä»»åŠ¡ 1       â”‚    â”‚  å¼‚æ­¥ä»»åŠ¡ 2       â”‚
â”‚  å›¾ç‰‡åˆ†æ         â”‚    â”‚  è·¯ç”±åˆ¤æ–­         â”‚
â”‚                  â”‚    â”‚                  â”‚
â”‚ supplyAsync()    â”‚    â”‚ supplyAsync()    â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜    â””â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
         â”‚                       â”‚
         â”‚ ã€ç¬¬ä¸€å±‚å¼‚å¸¸å¤„ç†ã€‘      â”‚
         â–¼                       â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”    â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ exceptionally()  â”‚    â”‚ exceptionally()  â”‚
â”‚ å¤±è´¥â†’è¿”å›null     â”‚    â”‚ å¤±è´¥â†’è¿”å›DEFAULT  â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜    â””â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
         â”‚                       â”‚
         â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                     â”‚
                     â–¼
         â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
         â”‚    thenCombine()       â”‚
         â”‚  ç»„åˆä¸¤ä¸ªä»»åŠ¡çš„ç»“æœ      â”‚
         â”‚                        â”‚
         â”‚  - ä¿å­˜æ•°æ®åº“           â”‚
         â”‚  - è¿”å›ç»„åˆç»“æœ         â”‚
         â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                     â”‚
                     â”‚ ã€ç¬¬äºŒå±‚å¼‚å¸¸å¤„ç†ã€‘
                     â–¼
         â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
         â”‚   orTimeout(30s)       â”‚
         â”‚   è®¾ç½®è¶…æ—¶æ—¶é—´          â”‚
         â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                     â”‚
                     â–¼
         â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
         â”‚  exceptionally()       â”‚
         â”‚  å¤„ç†ç»„åˆ/è¶…æ—¶å¼‚å¸¸      â”‚
         â”‚  å¤±è´¥â†’è¿”å›é»˜è®¤ç»“æœ      â”‚
         â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                     â”‚
                     â”‚ ã€ç¬¬ä¸‰å±‚å¼‚å¸¸å¤„ç†ã€‘
                     â–¼
         â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
         â”‚      handle()          â”‚
         â”‚   æœ€ç»ˆå¼‚å¸¸ä¿åº•å¤„ç†      â”‚
         â”‚   throwable != null?   â”‚
         â”‚     Yesâ†’è¿”å›é»˜è®¤å€¼      â”‚
         â”‚     Noâ†’è¿”å›æ­£å¸¸ç»“æœ     â”‚
         â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                     â”‚
                     â–¼
         â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
         â”‚       join()           â”‚
         â”‚    ç­‰å¾…æœ€ç»ˆç»“æœ         â”‚
         â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                     â”‚
                     â–¼
         â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
         â”‚     æå–ç»“æœæ•°æ®        â”‚
         â”‚  analysisResult        â”‚
         â”‚  routedScene           â”‚
         â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

## å¼‚å¸¸ä¼ æ’­è·¯å¾„

### æ­£å¸¸æµç¨‹ï¼ˆæ— å¼‚å¸¸ï¼‰

```
Task1 [Success] â”€â”€â”
                  â”œâ”€â”€> thenCombine [Success] â”€â”€> handle [Success] â”€â”€> Result
Task2 [Success] â”€â”€â”˜
```

### Task1 å¤±è´¥åœºæ™¯

```
Task1 [Fail] â”€â”€> exceptionally [Return null] â”€â”€â”
                                                â”œâ”€â”€> thenCombine [Success with null] â”€â”€> Result
Task2 [Success] â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

### Task2 å¤±è´¥åœºæ™¯

```
Task1 [Success] â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
                                                â”œâ”€â”€> thenCombine [Success with default] â”€â”€> Result
Task2 [Fail] â”€â”€> exceptionally [Return DEFAULT] â”˜
```

### ç»„åˆå¤±è´¥åœºæ™¯

```
Task1 [Success] â”€â”€â”
                  â”œâ”€â”€> thenCombine [Fail] â”€â”€> exceptionally [Return default] â”€â”€> Result
Task2 [Success] â”€â”€â”˜
```

### è¶…æ—¶åœºæ™¯

```
Task1 [Running...] â”€â”€â”
                     â”œâ”€â”€> thenCombine [Running...] â”€â”€> orTimeout [Timeout!] 
Task2 [Running...] â”€â”€â”˜                                      â”‚
                                                            â–¼
                                              exceptionally [Return default] â”€â”€> Result
```

### æœ€åæƒ…å†µï¼ˆæ‰€æœ‰å¼‚å¸¸å¤„ç†å¤±è´¥ï¼‰

```
Task1 [Fail] â”€â”€> exceptionally [Fail again] â”€â”€â”
                                               â”œâ”€â”€> thenCombine [Fail] 
Task2 [Fail] â”€â”€> exceptionally [Fail again] â”€â”€â”˜         â”‚
                                                         â–¼
                                            exceptionally [Fail again]
                                                         â”‚
                                                         â–¼
                                              handle [Catch all! Return default]
                                                         â”‚
                                                         â–¼
                                                      Result
```

## ä»£ç ç¤ºä¾‹å¯¹ç…§

### ç¬¬ä¸€å±‚ï¼šå•ä¸ªä»»åŠ¡å¼‚å¸¸å¤„ç†

```java
CompletableFuture<String> future1 = CompletableFuture
    .supplyAsync(() -> {
        // å¯èƒ½æŠ›å‡ºå¼‚å¸¸çš„é€»è¾‘
        return "result";
    })
    .exceptionally(ex -> {
        // âœ… ç¬¬ä¸€å±‚æ•è·
        log.error("Task failed", ex);
        return null;  // è¿”å›é»˜è®¤å€¼ï¼Œé˜»æ­¢å¼‚å¸¸ä¼ æ’­
    });
```

### ç¬¬äºŒå±‚ï¼šç»„åˆä»»åŠ¡å¼‚å¸¸å¤„ç†

```java
future1.thenCombine(future2, (r1, r2) -> {
        return combine(r1, r2);
    })
    .orTimeout(30, TimeUnit.SECONDS)
    .exceptionally(ex -> {
        // âœ… ç¬¬äºŒå±‚æ•è·ï¼ˆç»„åˆå¼‚å¸¸æˆ–è¶…æ—¶ï¼‰
        log.error("Combine failed or timeout", ex);
        return defaultResult;
    });
```

### ç¬¬ä¸‰å±‚ï¼šæœ€ç»ˆä¿åº•å¤„ç†

```java
    .handle((result, throwable) -> {
        if (throwable != null) {
            // âœ… ç¬¬ä¸‰å±‚æ•è·ï¼ˆå…œåº•ï¼‰
            log.error("Final fallback", throwable);
            return defaultResult;
        }
        return result;
    })
    .join();
```

## å¼‚å¸¸ç±»å‹å¯¹ç…§è¡¨

| å¼‚å¸¸æ¥æº | å¼‚å¸¸ç±»å‹ | è¢«å“ªå±‚æ•è· | å¤„ç†æ–¹å¼ |
|---------|---------|-----------|---------|
| Task æ‰§è¡Œå¤±è´¥ | Exception | ç¬¬ä¸€å±‚ exceptionally | è¿”å› null æˆ–é»˜è®¤å€¼ |
| è·¯ç”±åˆ¤æ–­å¤±è´¥ | RuntimeException | ç¬¬ä¸€å±‚ exceptionally | è¿”å› DEFAULT_ALL |
| ç»„åˆé€»è¾‘å¤±è´¥ | CompletionException | ç¬¬äºŒå±‚ exceptionally | è¿”å›é»˜è®¤ç»„åˆç»“æœ |
| è¶…æ—¶ | TimeoutException | ç¬¬äºŒå±‚ exceptionally | è¿”å›é»˜è®¤ç»„åˆç»“æœ |
| æœªçŸ¥å¼‚å¸¸ | Throwable | ç¬¬ä¸‰å±‚ handle | ä¿åº•è¿”å›é»˜è®¤å€¼ |

## å¯¹æ¯”ï¼šä¼ ç»Ÿ try-catch vs CompletableFuture

### âŒ ä¼ ç»Ÿæ–¹å¼ï¼ˆå‘½ä»¤å¼ï¼‰

```java
String result1 = null;
String result2 = null;

try {
    result1 = task1();  // å¯èƒ½æŠ›å¼‚å¸¸
} catch (Exception e) {
    log.error("Task1 failed", e);
    result1 = null;
}

try {
    result2 = task2();  // å¯èƒ½æŠ›å¼‚å¸¸
} catch (Exception e) {
    log.error("Task2 failed", e);
    result2 = "default";
}

try {
    Result combined = combine(result1, result2);  // å¯èƒ½æŠ›å¼‚å¸¸
} catch (Exception e) {
    log.error("Combine failed", e);
    combined = getDefault();
}
```

**é—®é¢˜**ï¼š
- ä¸²è¡Œæ‰§è¡Œï¼Œæ•ˆç‡ä½
- ä»£ç å†—é•¿ï¼ŒåµŒå¥—æ·±
- ä¸ç¬¦åˆå‡½æ•°å¼ç¼–ç¨‹

### âœ… CompletableFuture æ–¹å¼ï¼ˆå‡½æ•°å¼ï¼‰

```java
CompletableFuture<String> future1 = CompletableFuture
    .supplyAsync(() -> task1())
    .exceptionally(ex -> null);

CompletableFuture<String> future2 = CompletableFuture
    .supplyAsync(() -> task2())
    .exceptionally(ex -> "default");

Result combined = future1
    .thenCombine(future2, (r1, r2) -> combine(r1, r2))
    .exceptionally(ex -> getDefault())
    .handle((result, throwable) -> 
        throwable != null ? getDefault() : result)
    .join();
```

**ä¼˜åŠ¿**ï¼š
- âœ… å¹¶è¡Œæ‰§è¡Œï¼Œæ•ˆç‡é«˜
- âœ… ä»£ç ç®€æ´ï¼Œé“¾å¼è°ƒç”¨
- âœ… å®Œå…¨å‡½æ•°å¼ç¼–ç¨‹
- âœ… ä¸‰å±‚å¼‚å¸¸ä¿æŠ¤

## å…³é”®è¦ç‚¹

1. **æ°¸è¿œä¸è¦åœ¨å¼‚æ­¥ç¼–ç¨‹ä¸­ä½¿ç”¨ try-catch**
   - ç ´åå‡½æ•°å¼ç¼–ç¨‹èŒƒå¼
   - æ— æ³•åˆ©ç”¨ CompletableFuture çš„å¼‚å¸¸å¤„ç†é“¾

2. **ä¸ºæ¯ä¸ªå¼‚æ­¥ä»»åŠ¡æ·»åŠ  exceptionally**
   - é˜»æ­¢å¼‚å¸¸å‘ä¸Šä¼ æ’­
   - æä¾›é»˜è®¤å€¼ä½œä¸ºå…œåº•

3. **ç»„åˆä»»åŠ¡åæ·»åŠ  exceptionally**
   - å¤„ç†ç»„åˆè¿‡ç¨‹çš„å¼‚å¸¸
   - å¤„ç†è¶…æ—¶å¼‚å¸¸

4. **æœ€åæ·»åŠ  handle ä½œä¸ºæœ€ç»ˆä¿åº•**
   - æ•è·æ‰€æœ‰æœªå¤„ç†çš„å¼‚å¸¸
   - ä¿è¯ä¸€å®šè¿”å›ç»“æœ

5. **ä½¿ç”¨ join() è€Œé get()**
   - ä¸æŠ›å‡ºå—æ£€å¼‚å¸¸
   - ä»£ç æ›´ç®€æ´

## å®æˆ˜å»ºè®®

### å¼€å‘é˜¶æ®µ
- ä¿ç•™è¯¦ç»†çš„æ—¥å¿—è®°å½•
- æ¯å±‚å¼‚å¸¸éƒ½è¦è®°å½•
- ä¾¿äºè°ƒè¯•å’Œæ’æŸ¥é—®é¢˜

### ç”Ÿäº§é˜¶æ®µ
- ç›‘æ§å¼‚å¸¸å‘ç”Ÿé¢‘ç‡
- åˆ†æå¼‚å¸¸ç±»å‹åˆ†å¸ƒ
- ä¼˜åŒ–å¼‚å¸¸å¤„ç†ç­–ç•¥

### æ€§èƒ½ä¼˜åŒ–
- åˆç†è®¾ç½®è¶…æ—¶æ—¶é—´
- é¿å…è¿‡åº¦çš„å¼‚å¸¸å¤„ç†
- ä½¿ç”¨ç¼“å­˜å‡å°‘é‡è¯•

## æ€»ç»“

CompletableFuture çš„ä¸‰å±‚å¼‚å¸¸å¤„ç†æœºåˆ¶ï¼š

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ ç¬¬ä¸€å±‚ï¼šå•ä¸ªä»»åŠ¡çš„ exceptionally    â”‚
â”‚  - å¤„ç†ä»»åŠ¡æ‰§è¡Œå¼‚å¸¸                 â”‚
â”‚  - è¿”å›é»˜è®¤å€¼                       â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
               â”‚
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â–¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ ç¬¬äºŒå±‚ï¼šç»„åˆä»»åŠ¡çš„ exceptionally    â”‚
â”‚  - å¤„ç†ç»„åˆå¼‚å¸¸å’Œè¶…æ—¶               â”‚
â”‚  - è¿”å›é»˜è®¤ç»„åˆç»“æœ                 â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
               â”‚
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â–¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ ç¬¬ä¸‰å±‚ï¼šæœ€ç»ˆçš„ handle              â”‚
â”‚  - æ•è·æ‰€æœ‰æœªå¤„ç†å¼‚å¸¸               â”‚
â”‚  - ä¿è¯ä¸€å®šè¿”å›ç»“æœ                 â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

**è¿™æ˜¯æœ€å®‰å…¨ã€æœ€ä¼˜é›…çš„å¼‚æ­¥å¼‚å¸¸å¤„ç†æ–¹å¼ï¼** ğŸ‰

